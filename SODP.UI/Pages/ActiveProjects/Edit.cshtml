@page
@model EditModel

@using System.Web
@using System.Text.RegularExpressions;
@using SODP.Shared.Enums

@{
	ViewData["Title"] = "Szczegóły projektu";
}

<div class="col-8 p-0">
	<h2 class="text-info p-0">@ViewData["Title"]</h2>
</div>

<div class="p-0">
	<form method="post">
		<input name="IsValidate" type="hidden" value="@ViewData.ModelState.IsValid.ToString()" />
		<input asp-for="Project.Id" type="hidden" />
		<input asp-for="Project.Number" type="hidden" />
		<input asp-for="Project.StageId" type="hidden" />
		<input asp-for="Project.StageSign" type="hidden" />
		<input asp-for="Project.StageName" type="hidden" />

		<div class="col-lg-7 justify-content-end font-weight-bold p-0">
			<div>
				@Model.Project.Number
				@Model.Project.Stage
			</div>
			<div>
				@Model.Project.Name
			</div>
		</div>

		<br />

		<div class="form-group row">
			<div class="col-lg-7">
				<label>Nazwa projektu:</label>
				<input asp-for="Project.Name" class="form-control" placeholder="Nazwa projektu" />
				<span asp-validation-for="Project.Name" style="font-size:14px" class="text-danger"></span>
			</div>
		</div>

		<div class="form-group row">
			<div class="col-lg-7">
				<label>Nazwa zamierzenia budowlanego:</label>
				<textarea asp-for="Project.Title" class="form-control" placeholder="Nazwa zamierzenia budowlanego" rows="4"></textarea>
			</div>
		</div>

		<div class="form-group row">
			<div class="col-lg-7">
				<label>Adres:</label>
				<textarea asp-for="Project.Address" class="form-control" placeholder="Adres inwestycji" rows="3"></textarea>
			</div>
		</div>

		<div class="form-group row">
			<div class="col-lg-7">
				<label>Jednostka ewidencyjna:</label>
				<input asp-for="Project.LocationUnit" class="form-control" placeholder="Jednostka ewidencyjna" />
				<span asp-validation-for="Project.LocationUnit" style="font-size:14px" class="text-danger"></span>
			</div>
		</div>

		<div class="form-group row">
			<div class="col-lg-7">
				<label>Kategoria obiektu budowlanego:</label>
				<input asp-for="Project.BuildingCategory" class="form-control" placeholder="Kategoria obiektu budowlanego" />
				<span asp-validation-for="Project.BuildingCategory" style="font-size:14px" class="text-danger"></span>
			</div>
		</div>

		<div class="form-group row">
			<div class="col-lg-6">
				<label>Inwestor:</label>
				<textarea asp-for="Project.Investor" class="form-control" placeholder="Inwestor" rows="4"></textarea>
			</div>
			<div class="col-lg-1">
				<button type="button"
						class="col btn btn-info form-control text-white float-right h-100"
						title="Pobierz inwestora z bazy"
						data-toggle="ajax-modal"
						data-url="@Url.Page("Edit","InvestorsList")&projectId=@Model.Project.Id">
					...
				</button>
			</div>
		</div>

		<div class="form-group row">
			<div class="col-lg-7">
				<label>Pozwolenie na budowę:</label>
				<textarea asp-for="Project.BuildingPermit" class="form-control" placeholder="Nr pozwolenia na budowę" rows="2"></textarea>
			</div>
		</div>

		<div class="form-group row">
			<div class="col-lg-7">
				<label>Opis:</label>
				<textarea asp-for="Project.Description" class="form-control" placeholder="Opis (opcjonalny)" rows="2"></textarea>
			</div>
		</div>

		<div class="form-group row">
			<div class="col-lg-7">
				<label>Data opracowania:</label>
				<div class="input-group-append" data-date-format="dd/mm/yyyy">
					<input asp-for="Project.DevelopmentDate" class="form-control col" type="date"/>
				</div>
			</div>
		</div>

		<br />

		<div class="col-lg-7 form-group">
			@for (int i = 0; i < Model.Project.ProjectBranches.Branches.Count; i++)
			{
				<input asp-for="Project.ProjectBranches.Branches[i].Branch.Id" type="hidden">
				<input asp-for="Project.ProjectBranches.Branches[i].Branch.Name" type="hidden">
				<div class="row">
					<div class="col my-auto font-weight-bold">
						@Model.Project.ProjectBranches.Branches[i].Branch.Name
					</div>
					<div class="col-3 p-0 m-0">
						<div class="btn btn-md"
						 data-toggle="tooltip"
						 data-placement="top"
						 title="Ustaw funkcje techniczne"
						 onclick="EditRoles(@Model.Project.Id,@Model.Project.ProjectBranches.Branches[i].Branch.Id)">
							<i class="fas fa-edit fa-lg text-success"></i>
						</div>
						<div class="btn btn-md"
						 data-toggle="tooltip"
						 data-placement="top"
						 title="Usuń branżę"
						 onclick="RemoveBranch(@Model.Project.Id,@Model.Project.ProjectBranches.Branches[i].Branch.Id)">
							<i class="fas fa-times fa-lg text-danger"></i>
						</div>
					</div>
				</div>

				@foreach (var role in Model.Project.ProjectBranches.Branches[i].Roles)
				{
					<div class="row">
						<div class="col my-auto">@Model._translator.Translate(role.Role, Services.Languages.Pl) : @role.Designer (@role.Content)</div>
					</div>
				}
			}
		</div>

		<br />

		@if (Model.Project.AvailableBranches.Items.Count > 0)
		{
			<div class="col col-lg-7 form-group">
				<div class="row align-middle">
					<div class="col pt-1 pb-1">
						@Html.DropDownListFor(model => model.Project.AvailableBranches.SelectedId, @Model.Project.AvailableBranches.Items, new { @class = "form-control" })
						<span asp-validation-for="Project.AvailableBranches.SelectedId" style="font-size:14px" class="text-danger"></span>
					</div>
					<div class="btn btn-lg col-1" onclick="AddBranch(@Model.Project.Id, @Model.Project.AvailableBranches.SelectedId)">
						<i class="fas fa-plus text-success"></i>
					</div>
				</div>
			</div>
		}

		<div class="row">
			<div class="col-lg-7">
				<partial name="_SubmitAndBackButtonPartial" />
			</div>
		</div>
	</form>
</div>


@section Scripts{
	<partial name="/Pages/Shared/_ValidationScriptsPartial.cshtml" />
	<script>
		$('#myTab a').click(function (e) {
			e.preventDefault();
			$(this).tab('show');
		});

		// store the currently selected tab in the hash value
		$("ul.nav-tabs > li > a").on("shown.bs.tab", function (e) {
			var id = $(e.target).attr("href").substr(1);
			window.location.hash = id;
		});

		// on load of the page: switch to the currently selected tab
		var hash = window.location.hash;
		$('#myTab a[href="' + hash + '"]').tab('show');
	</script>

	<script>
		function EditRoles(projectId, branchId) {
			$.ajax({
				type: "Get",
				url: `@Url.Page("Edit","TechnicalRoles")&projectId=${projectId}&branchId=${branchId}`,
				success: function (data) {
					$('#modal-placeholder').html(data);
					$('#technicalRoles').modal('show');
				}
			})
		}

		function RemoveBranch(projectId, branchId) {
			$.ajax({
				type: "Delete",
				url: `@Url.Page("Edit", "Branch")&id=${projectId}&branchId=${branchId}`,
				beforeSend: function (xhr) {
					xhr.setRequestHeader("XSRF-TOKEN",
						$('input:hidden[name="__RequestVerificationToken"]').val());
				},
				success: function (data) {
					window.location.reload(true);
				}
			})
		}

		function AddBranch(projectId) {
			var selectedId = $("#Project_AvailableBranches_SelectedId").val();
			$.ajax({
				type: "Put",
				url: `@Url.Page("Edit", "Branch")&id=${projectId}&branchId=${selectedId}`,
				beforeSend: function (xhr) {
					xhr.setRequestHeader("XSRF-TOKEN",
						$('input:hidden[name="__RequestVerificationToken"]').val());
				},
				success: function (data) {
					window.location.reload(true);
				}
			})
		}

		function initModalPlaceHolder(returnUrl) {
			var placeholderElement = $('#modal-placeholder');
			placeholderElement.on('click', '[data-save="modal"]', function (event) {
				event.preventDefault();
				var form = $(this).parents('.modal').find('form');
				var actionUrl = form.attr('action');
				var dataToSend = form.serialize();
				$.post(actionUrl, dataToSend).done(function (data) {
					var newBody = $('.modal-body', data);
					placeholderElement.find('.modal-body').replaceWith(newBody);
					var isValid = newBody.find('[name="IsValidate"]').val() == 'True';
					var url = $(this).data('url');
					if (isValid) {
						placeholderElement.find('.modal').modal('hide');
						window.location.reload(true);
					}
				});
			});
		}
	</script>

	<script>
		$(document).ready(function () {
			$('[data-toggle="tooltip"]').tooltip();

			$('button[data-toggle="ajax-modal"]').click(function (event) {
				var url = $(this).data('url');
				$.get(url).done(function (data) {
					var placeholderElement = $('#modal-placeholder');
					placeholderElement.html(data);
					placeholderElement.find('.modal').modal('show');
				});
			});
			initModalPlaceHolder(window.location.href);
		});
	</script>
}